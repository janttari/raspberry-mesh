#install raspberry pi os lite (without desktop) and upgrade it
#in this test used version:
#Raspbian GNU/Linux 10
#Linux raspberrypi 5.10.17-v7l+ #1414 SMP Fri Apr 30 13:20:47 BST 2021 armv7l GNU/Linux
sudo apt update && sudo apt upgrade -y && sudo apt install -y hostapd
sudo systemctl unmask hostapd
sudo systemctl disable hostapd


#disable wpa_supplicant:
sudo systemctl disable wpa_supplicant.service

#install batctl from source
cd ~
sudo apt install -y libnl-genl-3-dev git
git clone https://github.com/open-mesh-mirror/batctl
cd batctl
sudo make install
cd ~

#install authsae: !!!!!EI!!!!
cd ~
sudo apt install -y gcc make cmake pkg-config libssl-dev libconfig-dev libnl-3-dev libnl-genl-3-dev
git clone https://github.com/cozybit/authsae.git
cd authsae/
sudo make all
cd ~

#reboot now:
sudo reboot

#-------------------------------------------------------------
#/etc/default/hostapd 
#/etc/hostapd/hostapd.conf
sudo systemctl disable hostapd

#
sudo apt install -y dnsmasq

#
sudo nano /etc/dhcpcd.conf
interface wlan0
    static ip_address=192.168.4.1/24
    nohook wpa_supplicant
------
sudo nano /etc/sysctl.d/routed-ap.conf
# https://www.raspberrypi.org/documentation/configuration/wireless/access-point-routed.md
# Enable IPv4 routing
net.ipv4.ip_forward=1
------

###sudo apt install -y netfilter-persistent
sudo DEBIAN_FRONTEND=noninteractive apt install -y netfilter-persistent iptables-persistent
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo netfilter-persistent save

#
sudo nano /etc/dnsmasq.conf
interface=wlan0 # Listening interface
dhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h
                # Pool of IP addresses served via DHCP
domain=wlan     # Local wireless DNS domain
address=/gw.wlan/192.168.4.1
                # Alias for this router
----

#!!!TÄRKEÄ:
konttiraspi/asenna-hostapdpaketit

#--------------------------------------------------------------
#mesh up:
sudo usb_modeswitch -K -W -v 0e8d -p 2870 -Q
sleep 3
sudo systemctl start hostapd
sudo iw dev wlan0 interface add mesh0 type mp addr 00:13:ef:5f:11:fa
sudo iwconfig mesh0 channel 11
sudo batctl if add mesh0

sudo batctl n
iw dev

ONGELMA:
kesä 18 08:33:25 raspberrypi systemd[1]: Failed to start Advanced IEEE 802.11 AP and IEEE 802.1X/WPA/WPA2/EAP Authenticator.

kun yrittää käynnistää hostapd kun mesh on ibss päällä!
-----------------------------------------------------------------------------
#mesh up:
sudo usb_modeswitch -K -W -v 0e8d -p 2870 -Q
sleep 3
#sudo killall wpa_supplicant
sudo service hostapd start
sudo modprobe batman-adv
sudo iw dev wlan0 interface add mesh0 type mp addr 00:13:ef:5f:11:fa

sudo ip link set mesh0 down
#sudo iw mesh0 set type mp
sudo iw dev mesh0 set type ibss
sudo iwconfig mesh0 channel 11
sudo ip link set mesh0 up

sudo batctl if add mesh0

sudo batctl n
iw dev

##sudo iw phy phy0 interface add wlan0 type station


---------------


